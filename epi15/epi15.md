# ğŸ¶ è¾“å…¥/è¾“å‡ºå‡½æ•°

- ANSI Cå’Œæ—©æœŸCç›¸æ¯”çš„æœ€å¤§ä¼˜ç‚¹ä¹‹ä¸€å°±æ˜¯å®ƒåœ¨è§„èŒƒé‡Œæ‰€åŒ…å«çš„å‡½æ•°åº“ã€‚æ¯ä¸ªANSIç¼–è¯‘å™¨å¿…é¡»æ”¯æŒä¸€ç»„è§„å®šçš„å‡½æ•°ï¼Œå¹¶å…·å¤‡è§„èŒƒæ‰€è¦æ±‚çš„æ¥å£ï¼Œè€Œä¸”æŒ‰ç…§è§„å®šçš„è¡Œä¸ºå·¥ä½œã€‚

## 15.1 é”™è¯¯æŠ¥å‘Š

`perror`å‡½æ•°ä»¥ä¸€ç§ç®€å•ã€ç»Ÿä¸€çš„æ–¹å¼æŠ¥å‘Šé”™è¯¯ã€‚ï¼ˆåŸå‹å®šä¹‰äºstdio.hï¼‰

~~~C
void perror(char const *message);
~~~

> æ ‡å‡†åº“å‡½æ•°åœ¨ç¨‹åºå­˜åœ¨é”™è¯¯æ—¶åœ¨ä¸€ä¸ªå¤–éƒ¨æ•´å‹å˜é‡`errno`ï¼ˆåœ¨errno.hä¸­å®šä¹‰ï¼‰ä¸­ä¿å­˜é”™è¯¯ä»£ç åæŠŠè¿™ä¸ªä¿¡æ¯ä¼ é€’ç»™ç”¨æˆ·ç¨‹åºï¼Œæç¤ºæ“ä½œå¤±è´¥çš„å‡†ç¡®åŸå› ã€‚
>> perroræœ€å¤§çš„ä¼˜ç‚¹å°±æ˜¯å®¹æ˜“ä½¿ç”¨ã€‚

## 15.2 ç»ˆæ­¢æ‰§è¡Œ

`exit`å‡½æ•°ç”¨äºç»ˆæ­¢ä¸€ä¸ªç¨‹åºçš„æ‰§è¡Œã€‚ï¼ˆåŸå‹å®šä¹‰äºstdlib.hï¼‰

~~~C
void exit(int status);
~~~

`status`å‚æ•°è¿”å›ç»™æ“ä½œç³»ç»Ÿï¼Œç”¨äºæç¤ºç¨‹åºæ˜¯å¦æ­£å¸¸å®Œæˆã€‚
> é¢„å®šä¹‰ç¬¦å·EXIT_SUCCESS å’Œ EXIT_FAILURE åˆ†åˆ«æç¤ºç¨‹åºçš„ç»ˆæ­¢æ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ã€‚
>> ä¸€èˆ¬æ‰§è¡Œå®Œ`perror`åéƒ½ä¼šæ‰§è¡Œ`exit`

## 15.3 æ ‡å‡†I/Oå‡½æ•°åº“

- æ ‡å‡†I/Oå‡½æ•°åº“æ˜¯åœ¨åŸå…ˆI/Oåº“åŸºç¡€ä¸Šçš„å®ç°å’Œæ‰©å±•ï¼Œä¾‹å¦‚ä¸ºprintfåˆ›å»ºäº†ä¸åŒçš„ç‰ˆæœ¬ã€‚ä¸”å‡½æ•°åº“å¼•å…¥äº†ç¼“å†²I/Oçš„æ¦‚å¿µï¼Œæé«˜äº†ç»å¤§å¤šæ•°ç¨‹åºçš„æ•ˆç‡ã€‚

> ä½†æ˜¯æ ‡å‡†å‡½æ•°åº“æ˜¯åœ¨æŸå°ç‰¹å®šç±»å‹æœºå™¨ä¸Šå®ç°çš„ï¼Œåœ¨å…¶ä»–ä¸åŒç±»å‹çš„æœºå™¨ä¸Šè¿è¡Œç›¸åŒçš„ç¨‹åºä¼šå‡ºç°æ— æ³•è¿è¡Œçš„æƒ…å†µã€‚

- ANSI Cå‡½æ•°åº“ä¸­çš„I/Oå‡½æ•°åœ¨å¯ç§»æ¤æ€§å’Œå®Œæ•´æ€§ä¸Šæ›´åŠ å®Œå–„ã€‚

> ANSI Cçš„ä¸€ä¸ªä¸»è¦ä¼˜ç‚¹å°±æ˜¯è¿™äº›ä¿®æ”¹æ˜¯é€šè¿‡**å¢åŠ ä¸åŒçš„å‡½æ•°**æ–¹å¼å®ç°ï¼Œè€Œä¸æ˜¯é€šè¿‡å¯¹ç°å­˜å‡½æ•°è¿›è¡Œä¿®æ”¹æ¥å®ç°ï¼Œä¿è¯äº†ç¨‹åºçš„å¯ç§»æ¤æ€§ã€‚

## 15.4 ANSI I/Oæ¦‚å¿µ

- å¤´æ–‡ä»¶`<stdio.h>`åŒ…å«äº†ä¸ANSIå‡½æ•°åº“çš„I/Oéƒ¨åˆ†æœ‰å…³çš„å£°æ˜ã€‚

> å°½ç®¡ä¸åŒ…å«è¿™ä¸ªå¤´æ–‡ä»¶ä¹Ÿèƒ½ä½¿ç”¨æŸäº›I/Oå‡½æ•°ï¼Œä½†ç»å¤§å¤šæ•°å‡½æ•°éƒ½éœ€è¦åŒ…å«è¿™ä¸ªå¤´æ–‡ä»¶ã€‚
>
### 15.4.1 æµ

- ANSI Cå¯¹I/Oçš„æ¦‚å¿µè¿›è¡ŒæŠ½è±¡ï¼Œæ‰€æœ‰çš„I/Oæ“ä½œåªæ˜¯ç®€å•çš„ç§»å…¥/ç§»å‡ºå­—èŠ‚ã€‚è¿™ç§å­—èŠ‚æµä¾¿ç§°ä¸º**æµ(stream)**ã€‚

1. æ ¸å¿ƒæ¦‚å¿µï¼šæŠ½è±¡(Abstraction)

- **æµçš„æœ¬è´¨**ï¼šæµæ˜¯å¯¹æ‰€æœ‰I/Oæ“ä½œçš„æŠ½è±¡
- **ç»Ÿä¸€æ¥å£**ï¼šæ‰€æœ‰çš„I/Oè®¾å¤‡éƒ½è¢«è§†ä¸ºç±»ä¼¼çš„è®¾å¤‡ã€‚
- **ç¨‹åºè§†è§’**ï¼šå¯¹Cç¨‹åºè€Œè¨€ï¼Œæ‰€æœ‰çš„I/Oæ“ä½œéƒ½åªæ˜¯åœ¨æµä¸Šè¿›è¡Œå­—èŠ‚çš„ç§»è¿›æˆ–ç§»å‡ºã€‚
- **ç»†èŠ‚éšè—**ï¼šç‰¹å®šçš„I/Oè®¾å¤‡çš„ç»†èŠ‚å¯¹ç¨‹åºå‘˜æ˜¯éšè—çš„ã€‚

2. æ ¸å¿ƒæœºåˆ¶ï¼šç¼“å†²(Buffering)

å¤§å¤šæ•°æµæ˜¯***å®Œå…¨ç¼“å†²çš„(fully buffered)***

- **è¯»å–æ“ä½œ**ï¼šå½“è¿›è¡Œ"è¯»å–"æ—¶ï¼Œå®é™…ä¸Šæ˜¯ä»ä¸€å—è¾ƒå¤§çš„ç¼“å†²åŒº(buffer)ä¸­è¯»å–æ•°æ®ã€‚å½“ç¼“å†²åŒºç©ºæ—¶ï¼Œç¨‹åºæ‰é€šè¿‡è®¾å¤‡æˆ–æ–‡ä»¶è¯»å–ä¸‹ä¸€å—è¾ƒå¤§çš„è¾“å…¥æ•°æ®å¹¶é‡æ–°å¡«å……ç¼“å†²åŒºã€‚
- **å†™å…¥æ“ä½œ**ï¼š"å†™å…¥"ä¹Ÿæ˜¯å…ˆå†™å…¥åˆ°å†…å­˜ä¸­çš„ç¼“å†²åŒºï¼Œç›´åˆ°ç¼“å†²åŒºå†™æ»¡æ—¶ï¼Œæ•°æ®æ‰è¢«ä¸€æ¬¡æ€§å†™å…¥(flush,å†²æ´—æˆ–åˆ·æ–°)åˆ°è®¾å¤‡æˆ–æ–‡ä»¶ã€‚
- **æ•ˆç‡ä¼˜åŠ¿**ï¼šè¿™ç§å—çŠ¶å†™å…¥å’Œè¯»å–æ“ä½œç”±äºå‡å°‘äº†ä¸è®¾å¤‡æˆ–æ–‡ä»¶çš„äº¤äº’æ¬¡æ•°ï¼Œèƒ½å¤Ÿå®ç°æ›´å¿«é€Ÿçš„I/Oã€‚

è§£å†³è¾“å‡ºå»¶è¿Ÿ

~~~C
printf("something or other");
fflush(stdout); // ç«‹å³å°†ç¼“å†²åŒºå†…å®¹å†™å‡º
~~~

> åœ¨é€šå¸¸çš„ç¼–ç¨‹æµ‹è¯•ä¸­ï¼Œstdouté»˜è®¤æ˜¯è¡Œç¼“å†²æ¨¡å¼ã€‚

~~~C
// æ²¡æœ‰\nè§¦å‘è‡ªåŠ¨åˆ·æ–°ï¼Œä¼šæš‚åœäº”ç§’åå†æ‰§è¡Œprintf
#include <stdio.h>
#include <unistd.h> // for sleep

int main() {
    // 1. æ²¡æœ‰ \nï¼Œæ•°æ®è¿›å…¥ç¼“å†²åŒºï¼Œä½†ä¸ä¼šè‡ªåŠ¨åˆ·æ–°
    printf("ç­‰å¾… 5 ç§’ï¼Œä½ å¯èƒ½çœ‹ä¸åˆ°æˆ‘...");
    
    // 2. æš‚åœæ‰§è¡Œ
    sleep(5); 

    // 3. è¡¥ä¸Š \n
    printf("\næˆ‘ç°åœ¨å‡ºæ¥äº†ã€‚\n"); 
    return 0;
}
~~~

~~~C
// æœ‰\nè§¦å‘è‡ªåŠ¨åˆ·æ–°ï¼Œä¼šå…ˆæ‰§è¡Œprintfåç­‰å¾…äº”ç§’åæ‰§è¡Œå¦ä¸€ä¸ªprintf
#include <stdio.h>
#include <unistd.h> // for sleep

int main() {
    printf("ç­‰å¾… 5 ç§’ï¼Œä½ åº”è¯¥èƒ½çœ‹åˆ°æˆ‘...\n");
    
    // 2. æš‚åœæ‰§è¡Œ
    sleep(5); 

    // 3. è¡¥ä¸Š \n
    printf("\næˆ‘ç°åœ¨å‡ºæ¥äº†ã€‚\n"); 
    return 0;
}
~~~

> stdinæ˜¯ç±»ä¼¼çš„ï¼Œéƒ½æ˜¯è¡Œç¼“å†²æ¨¡å¼ã€‚

- å¯¹äºè¾“å…¥æµæ¥è¯´ï¼Œåªæœ‰ç¼“å†²åŒºç©ºäº†ï¼Œç¨‹åºæ‰ä¼šä»å¤–éƒ¨è®¾å¤‡è·å–æ–°çš„æ•°æ®æ¥å¡«å……å®ƒã€‚
- å¯¹äºè¾“å‡ºæµæ¥è¯´ï¼Œåªæœ‰ç¼“å†²åŒºæ»¡äº†ï¼Œç¼“å†²åŒºä¸­çš„æ•°æ®æ‰ä¼šè¢«å†™å…¥åˆ°å¤–éƒ¨è®¾å¤‡ï¼Œè¿›è¡Œåˆ·æ–°ã€‚

#### ä¸€ã€æ–‡æœ¬æµ(Text Stream)

æµåˆ†ä¸ºä¸¤ç§ï¼Œ**æ–‡æœ¬(text)æµ** å’Œ **äºŒè¿›åˆ¶(binary)** æµã€‚æ–‡æœ¬æµçš„æœ‰äº›ç‰¹æ€§åœ¨ä¸åŒçš„ç³»ç»Ÿä¸­å¯èƒ½ä¸åŒã€‚å…¶ä¸­ä¹‹ä¸€å°±æ˜¯æ–‡æœ¬è¡Œçš„æœ€å¤§é•¿åº¦ã€‚æ ‡å‡†è§„å®šè‡³å°‘å…è®¸254ä¸ªå­—ç¬¦ã€‚å¦ä¸€ä¸ªå¯èƒ½ä¸åŒçš„ç‰¹æ€§æ˜¯æ–‡æœ¬è¡Œçš„ç»“æŸæ–¹å¼ã€‚ä¾‹å¦‚åœ¨***MS-DOS***ç³»ç»Ÿä¸­ï¼Œæ–‡æœ¬æ–‡ä»¶çº¦å®šä»¥ä¸€ä¸ªå›è½¦ç¬¦å’Œä¸€ä¸ªæ¢è¡Œç¬¦ï¼ˆæˆ–ç§°ä¸ºè¡Œåé¦ˆç¬¦ï¼‰ç»“å°¾ã€‚ä½†æ˜¯***UNIX***ç³»ç»Ÿåªä½¿ç”¨ä¸€ä¸ªæ¢è¡Œç¬¦ç»“å°¾ã€‚

- æ ¸å¿ƒç‰¹ç‚¹ï¼šå­—ç¬¦ç¿»è¯‘

æ–‡æœ¬æµåœ¨æ•°æ®ä¼ è¾“ä¸­ä¼šå¼•å…¥ä¸€ä¸ª**ç¿»è¯‘å±‚**ï¼Œä¸»è¦é’ˆå¯¹æ¢è¡Œç¬¦(`\n`)ï¼š

|æ“ä½œ|Cç¨‹åºä¸­çš„è¡¨ç¤º|æ“ä½œç³»ç»Ÿ/æ–‡ä»¶ä¸­å®é™…å­˜å‚¨çš„è¡¨ç¤º|
|:---:|:---:|:---:|
|å†™å…¥(`fprintf`,`fputs`)|å†™å…¥ä¸€ä¸ªæ¢è¡Œç¬¦(`\n`)|æ“ä½œç³»ç»Ÿå¯èƒ½ä¼šå°†å…¶ç¿»è¯‘æˆä¸€ä¸ªæˆ–å¤šä¸ªå­—ç¬¦åºåˆ—(ä¾‹å¦‚Windowsä¸‹çš„`\r\n`)|
|è¯»å–(`fscanf`,`fgets`)|ä»æ–‡ä»¶ä¸­è¯»å–å¤šä¸ªå­—ç¬¦åºåˆ—ï¼ˆä¾‹å¦‚Windowsä¸‹çš„`\r\n`ï¼‰|Cè¿è¡Œæ—¶åº“ä¼šå°†è¿™ä¸ªåºåˆ—ç¿»è¯‘å›å•ä¸ªæ¢è¡Œç¬¦(`\n`)ä¾›Cç¨‹åºä½¿ç”¨ã€‚|

- ä¼˜ç‚¹ï¼šä¿æŒäº†è·¨å¹³å°çš„**æ–‡æœ¬æ–‡ä»¶å…¼å®¹æ€§**ã€‚å¯ä»¥åœ¨ä»»ä½•ç³»ç»Ÿä¸Šæ‰“å¼€å¹¶æ­£ç¡®æ˜¾ç¤ºç”¨æ–‡æœ¬æ¨¡å¼åˆ›å»ºçš„æ–‡ä»¶ã€‚
- ç¼ºç‚¹ï¼šä¼ è¾“çš„æ•°æ®é‡å¯èƒ½ä¸æ–‡ä»¶ä¸­å®é™…å­˜å‚¨çš„å­—èŠ‚æ•°**ä¸ä¸€è‡´**ï¼ˆå› ä¸ºç¿»è¯‘ï¼‰ï¼Œä¸”æ€§èƒ½ç•¥ä½äºäºŒè¿›åˆ¶æµã€‚

#### äºŒã€äºŒè¿›åˆ¶æµ(Binary Stream)

äºŒè¿›åˆ¶æµä¸­çš„å­—èŠ‚å°†å®Œå…¨æ ¹æ®ç¨‹åºç¼–å†™å®ƒä»¬çš„å½¢å¼å†™å…¥åˆ°æ–‡ä»¶æˆ–è®¾å¤‡ä¸­ï¼Œè€Œä¸”å®Œå…¨æ ¹æ®å®ƒä»¬ä»æ–‡ä»¶æˆ–è®¾å¤‡è¯»å–çš„å½¢å¼è¯»å…¥åˆ°ç¨‹åºä¸­ã€‚å¹¶æœªåšä»»ä½•æ”¹å˜ã€‚

- æ ¸å¿ƒç‰¹ç‚¹ï¼šæ— ç¿»è¯‘

äºŒè¿›åˆ¶æµæ˜¯**é€æ˜çš„**ï¼Œå®ƒç»•è¿‡äº†Cè¿è¡Œæ—¶åº“çš„ä»»ä½•ç¿»è¯‘ï¼š

|æ“ä½œ|Cç¨‹åºä¸­çš„è¡¨ç¤º|æ“ä½œç³»ç»Ÿ/æ–‡ä»¶ä¸­å®é™…å­˜å‚¨çš„è¡¨ç¤º|
|:---:|:---:|:---:|
|å†™å…¥(`fwrite`)|å†™å…¥Nä¸ªå­—èŠ‚|æ–‡ä»¶ä¸­ç²¾ç¡®å­˜å‚¨Nä¸ªå­—èŠ‚ï¼Œä¸åšä»»ä½•ä¿®æ”¹ã€‚|
|è¯»å–(`fread`)|è¯»å–Nä¸ªå­—èŠ‚|ä»æ–‡ä»¶ä¸­è¯»å–Nä¸ªåŸå§‹å­—èŠ‚åˆ°å†…å­˜ä¸­ï¼Œä¸åšä»»ä½•ä¿®æ”¹ã€‚|

- ä¼˜ç‚¹ï¼š1.ç²¾ç¡®æ€§ï¼šæ–‡ä»¶ä¸­çš„å­—èŠ‚æ•°ä¸ç¨‹åºå¤„ç†çš„å­—èŠ‚æ•°æ€»æ˜¯ç²¾å‡†åŒ¹é…ã€‚é€‚ç”¨äºå­˜å‚¨å›¾ç‰‡ã€éŸ³é¢‘ã€ç»“æ„ä½“ã€åŠ å¯†æ•°æ®ç­‰ã€‚2.æ€§èƒ½ï¼šç”±äºæ²¡æœ‰ç¿»è¯‘å¼€é”€ï¼ŒI/Oæ“ä½œé€šå¸¸æ›´å¿«ã€‚
- ç¼ºç‚¹ï¼š**ç¼ºä¹å¯ç§»æ¤æ€§**ã€‚å¦‚æœç›´æ¥å°†Cç»“æ„ä½“å†™å…¥äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ–‡ä»¶å°†ä¾èµ–äºæœºå™¨çš„å­—èŠ‚åº(Endianness)å’Œæ•°æ®ç±»å‹å¤§å°ã€‚

#### ä¸‰ã€ç¼–ç¨‹å®ç°ä¸Šçš„åŒºåˆ«

åœ¨Cè¯­è¨€ä¸­ï¼Œä½ é€šè¿‡`fopen()`å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼ˆæ¨¡å¼å­—ç¬¦ä¸²ï¼‰æ¥æŒ‡å®šä½¿ç”¨å“ªç§æµæ¨¡å¼ï¼š

|æ¨¡å¼|æè¿°|
|:--|:--|
|`"r"`/`"w"`/`"a"`|æ–‡æœ¬æ¨¡å¼(é»˜è®¤)|
|`"rb"`/`"wb"`/`"ab"`|äºŒè¿›åˆ¶æ¨¡å¼(åŠ `b`)|

### 15.4.2 æ–‡ä»¶

`stdio.h`æ‰€åŒ…å«çš„å£°æ˜ä¹‹ä¸€å°±æ˜¯`FILE`ç»“æ„ã€‚`FILE`æ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œç”¨äºè®¿é—®ä¸€ä¸ªæµã€‚å¦‚æœåŒæ—¶æ¿€æ´»å‡ ä¸ªæµæ¯ä¸ªæµéƒ½æœ‰ä¸€ä¸ªç›¸åº”çš„`FILE`ä¸å®ƒå…³è”ã€‚

- å¯¹äºæ¯ä¸ªANSI Cç¨‹åºï¼Œè¿è¡Œæ—¶ç³»ç»Ÿå¿…é¡»æä¾›è‡³å°‘ä¸‰ä¸ªæµï¼š**æ ‡å‡†è¾“å…¥(standard input)**ã€**æ ‡å‡†è¾“å‡º(standard output)**å’Œ**æ ‡å‡†é”™è¯¯(standard error)**ã€‚åå­—åˆ†åˆ«ä¸º`stdin`ã€`stdout`ã€`stderr`ã€‚è¿™ä¸‰ä¸ªæµéƒ½æ˜¯æŒ‡å‘`FILE`ç»“æ„çš„æŒ‡é’ˆã€‚

> æ ‡å‡†è¾“å…¥æ˜¯ç¼ºçœè¾“å…¥æ¥æºï¼Œæ ‡å‡†è¾“å‡ºæ˜¯ç¼ºçœè¾“å‡ºè®¾ç½®ï¼Œæ ‡å‡†é”™è¯¯æ˜¯ç¼ºçœé”™è¯¯è®¾ç½®ã€‚é€šå¸¸æ ‡å‡†è¾“å…¥ä¸ºé”®ç›˜è®¾ç½®ï¼Œæ ‡å‡†è¾“å‡ºä¸ºç»ˆç«¯æˆ–å±å¹•ã€‚
> å¯ä»¥å°†æ ‡å‡†è¾“å…¥å’Œæ ‡å‡†è¾“å‡ºè®¾ç½®ä¸ºå…¶ä»–è®¾å¤‡ã€‚

### 15.4.3 æ ‡å‡†I/Oå¸¸é‡

`EOF`æ˜¯è®¸å¤šå‡½æ•°çš„è¿”å›å€¼ï¼Œæç¤ºè¾¾åˆ°äº†æ–‡ä»¶å°¾ã€‚**EOFæ‰€é€‰æ‹©çš„å®é™…å€¼æ¯”ä¸€ä¸ªå­—ç¬¦å¤šå‡ ä½ï¼Œè¿™æ˜¯ä¸ºäº†é¿å…äºŒè¿›åˆ¶è¢«é”™è¯¯åœ°è§£é‡Šä¸ºEOFã€‚**

- è¾“å…¥å‡½æ•°è¿”å›`int`ç±»å‹ï¼š`getchar()`å’Œ`fgetc()`ç­‰å‡½æ•°è¢«è®¾è®¡ä¸ºè¿”å›`int`(32ä½æˆ–16ä½)ï¼Œè€Œä¸æ˜¯`char`(8ä½)ã€‚
- EOFçš„å€¼ï¼šä¸€èˆ¬ä¸ºè´Ÿæ•´æ•°`-1`ã€‚

|çŠ¶æ€|è¿”å›å€¼|ä½å®½åˆ©ç”¨|
|:---:|:---:|:---:|
|æˆåŠŸè¯»å–æœ‰æ•ˆå­—ç¬¦|è¿”å›å€¼æ˜¯ä¸€ä¸ª0åˆ°255ä¹‹é—´çš„æ•´æ•°|ä»…ä½¿ç”¨äº†`int`çš„ä½8ä½æ¥å­˜å‚¨å­—ç¬¦ä»£ç ï¼Œå…¶ä½™ä½æ˜¯0ã€‚|
|é‡åˆ°æ–‡ä»¶ç»“æŸ(EOF)|è¿”å›å€¼æ˜¯ä¸€ä¸ªè´Ÿæ•´æ•°(-1)|`int`çš„æ‰€æœ‰ä½éƒ½è¢«è®¾ç½®æˆ-1çš„äºŒè¿›åˆ¶è¡¨ç¤º(æ‰€æœ‰32ä½éƒ½æ˜¯1)|

> ä¸€ä¸ªç¨‹åºè‡³å°‘å¯ä»¥æ‰“å¼€**FOPEN_MAX**ä¸ªæ–‡ä»¶ï¼Œè‡³å°‘æ˜¯8ã€‚æœ‰ä¸€ä¸ªå¸¸é‡**FILENAME_MAX**æç¤ºå­—ç¬¦æ•°ç»„åº”è¯¥å¤šå¤§ä»¥ä¾¿å®¹çº³ç¼–è¯‘å™¨æ‰€æ”¯æŒçš„æœ€é•¿åˆæ³•æ–‡ä»¶åã€‚

## 15.5 æµI/Oæ€»è§ˆ

å¯¹äºæ–‡ä»¶æµæˆ–è®¾å¤‡æµ

1. ä½¿ç”¨`FILE*`å°†å¤„äºæ´»åŠ¨çŠ¶æ€çš„æ–‡ä»¶é€‰æ‹©ä½¿ç”¨ã€‚
2. æµé€šè¿‡è°ƒç”¨`fopen`å‡½æ•°æ‰“å¼€ã€‚ä¸ºäº†æ‰“å¼€ä¸€ä¸ªæµå¿…é¡»æŒ‡å®šè¦è®¿é—®çš„æ–‡ä»¶æˆ–è®¾å¤‡ä»¥åŠä»–ä»¬çš„è®¿é—®æ–¹å¼ã€‚`fopen`å’Œæ“ä½œç³»ç»ŸéªŒè¯æ–‡ä»¶æˆ–è®¾å¤‡ç¡®å®å­˜åœ¨å¹¶åˆå§‹åŒ–FILEç»“æ„ã€‚
3. å¯¹æ–‡ä»¶æˆ–è®¾å¤‡è¯»å–å†™å…¥ã€‚
4. æœ€åè°ƒç”¨`fclose`å‡½æ•°å…³é—­æµã€‚é˜²æ­¢è¢«å†æ¬¡è®¿é—®ï¼Œä¿è¯ä»»ä½•å­˜å‚¨äºç¼“å†²åŒºçš„æ•°æ®è¢«æ­£ç¡®åœ°å†™åˆ°æ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”é‡Šæ”¾FILEç»“æ„ä½¿å®ƒå¯ä»¥ç”¨äºå¦å¤–çš„æ–‡ä»¶ã€‚

> æ ‡å‡†æµä¸éœ€è¦æ‰“å¼€æˆ–å…³é—­ã€‚

**æ‰§è¡Œå­—ç¬¦ã€æ–‡æœ¬è¡Œå’ŒäºŒè¿›åˆ¶I/Oçš„å‡½æ•°**

|æ•°æ®ç±»å‹|è¾“å…¥|è¾“å‡º|æè¿°|
|:---|:---|:---|:---|
|å­—ç¬¦|getchar|putchar|è¯»å–(å†™å…¥)å•ä¸ªå­—ç¬¦|
|æ–‡æœ¬è¡Œ|gets/scanf|puts/printf|æ–‡æœ¬è¡Œæœªæ ¼å¼åŒ–çš„è¾“å…¥(è¾“å‡º)/æ ¼å¼åŒ–çš„è¾“å…¥(è¾“å‡º)|
|äºŒè¿›åˆ¶æ•°æ®|fread|fwrite|è¯»å–(å†™å…¥)äºŒè¿›åˆ¶æ•°æ®|

> å¸¦få‰ç¼€çš„è¾“å…¥è¾“å‡ºå‡½æ•°å¯ä»¥ç”¨äºæ‰€æœ‰æµã€‚

## 15.6 æ‰“å¼€æµ

`fopen`å‡½æ•°ç”¨äºåˆ›å»ºå¹¶æ‰“å¼€ä¸€ä¸ªæ–°æµã€‚

~~~C
FILE *fopen(char const *name, char const *mode);
~~~

`mode`å‚æ•°ä¸Šé¢ç¼–ç¨‹å®ç°ç»™å‡º
> åœ¨mode ä¸­æ·»åŠ  `a+`è¡¨ç¤ºè¯¥æ–‡ä»¶æ‰“å¼€ç”¨äºæ›´æ–°ï¼Œå¹¶ä¸”æµæ—¢å…è®¸è¯»ä¹Ÿå…è®¸å†™ã€‚
> ä½†æ˜¯åœ¨å‘æµå†™å…¥æ•°æ®å‰å¿…é¡»è°ƒç”¨å…¶ä¸­ä¸€ä¸ªæ–‡ä»¶å®šä½å‡½æ•°(`fseek`ã€`fsetpos`ã€`rewind`)ã€‚
> åœ¨å†™ååˆæƒ³è¯»å–æ•°æ®é¦–å…ˆå¿…é¡»è°ƒç”¨`fflush`å‡½æ•°æˆ–æ–‡ä»¶å®šä½å‡½æ•°ä¹‹ä¸€ã€‚

åº”è¯¥å§‹ç»ˆæ£€æŸ¥`fopen`å‡½æ•°çš„è¿”å›å€¼ï¼å¦‚æœå‡½æ•°å¤±è´¥ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªNULLå€¼ã€‚

~~~C
FILE *input;
input = fopen("data3", "r"); // æ–‡æœ¬åªè¯»
if (input == NULL)
{
  perror("failed to open file data3, Quitting...");
  exit(EXIT_FAILURE);
}
// åœ¨ç»ˆç«¯æŠ¥é”™ç±»ä¼¼ï¼šdata3: No such file or directory
~~~

`freopen`å‡½æ•°ç”¨äºæ‰“å¼€ï¼ˆæˆ–é‡æ–°æ‰“å¼€ï¼‰ä¸€ä¸ªç‰¹å®šçš„æ–‡ä»¶æµã€‚åŸå‹å¦‚ä¸‹ï¼š

~~~C
FILE* freopen(char const *filename, char const *mode, FILE *stream);
~~~

æœ€å¤§çš„ä½œç”¨æ˜¯æ”¹å˜æµçš„è¾“å…¥è¾“å‡º
> `freopen`å‡½æ•°åœ¨æ‰§è¡ŒæˆåŠŸæ—¶ï¼Œå®ƒè¿”å›çš„æŒ‡é’ˆå’Œä¼ å…¥çš„ç¬¬ä¸‰ä¸ªå‚æ•°`stream`æ˜¯åŒä¸€ä¸ªæŒ‡é’ˆï¼Œå³å®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ª`FILE`ç»“æ„ä½“ã€‚

~~~C
#include <stdio.h>
#include <stdlib.h> // ç”¨äº EXIT_FAILURE

int main() {
    // 1. åˆå§‹çŠ¶æ€ï¼šprintf è¾“å‡ºåˆ°ç»ˆç«¯
    printf("--- ç¨‹åºå¼€å§‹ ---\n");
    printf("è¿™æ¡ä¿¡æ¯åº”è¯¥æ˜¾ç¤ºåœ¨ç»ˆç«¯ä¸Šã€‚\n");

    // =======================================================
    // 2. ä½¿ç”¨ freopen é‡å®šå‘æ ‡å‡†è¾“å‡º (stdout)
    //    å‚æ•°: 
    //      "log.txt": æ–°çš„æ–‡ä»¶å
    //      "w": å†™å…¥æ¨¡å¼ (ä¼šè¦†ç›–æ–‡ä»¶åŸæœ‰å†…å®¹)
    //      stdout: è¦é‡å®šå‘çš„ç›®æ ‡æµ
    // =======================================================
    FILE *original_stdout = freopen("log.txt", "w", stdout);

    // æ£€æŸ¥é‡å®šå‘æ˜¯å¦æˆåŠŸ
    if (original_stdout == NULL) {
        // å¦‚æœé‡å®šå‘å¤±è´¥ï¼Œé€šå¸¸æ˜¯æ–‡ä»¶è·¯å¾„é—®é¢˜
        perror("freopen å¤±è´¥");
        return EXIT_FAILURE;
    }

    // 3. é‡å®šå‘åçš„çŠ¶æ€ï¼šprintf è¾“å‡ºåˆ° log.txt æ–‡ä»¶
    printf("è¿™æ¡ä¿¡æ¯ä¸ä¼šæ˜¾ç¤ºåœ¨ç»ˆç«¯ï¼Œè€Œæ˜¯å†™å…¥ log.txtã€‚\n");
    printf("freopen æˆåŠŸåœ°å°†æ ‡å‡†è¾“å‡ºæ”¹å˜äº†æ–¹å‘ã€‚\n");
    printf("--- ç¨‹åºç»“æŸ ---\n");

    // 4. å…³é—­æ–‡ä»¶æµå¹¶è¿”å›
    // freopen å·²ç»å…³é—­äº†æ—§çš„ stdoutï¼ˆç»ˆç«¯ï¼‰ï¼Œå¹¶æ‰“å¼€äº†æ–°çš„æ–‡ä»¶ã€‚
    // ç¨‹åºç»“æŸæ—¶ä¼šè‡ªåŠ¨å…³é—­ log.txtï¼Œä½†æ˜ç¡®å…³é—­æ˜¯å¥½ä¹ æƒ¯
    if (fclose(stdout) != 0) {
        perror("å…³é—­ stdout å¤±è´¥");
    }
    
    // æ³¨æ„ï¼šç¨‹åºä¸ä¼šè¾“å‡ºä»»ä½•æˆåŠŸä¿¡æ¯åˆ°ç»ˆç«¯ï¼Œå› ä¸ºå®ƒè¢«é‡å®šå‘äº†
    return 0;
}
~~~

## 15.7 å…³é—­æµ

ä½¿ç”¨`fclose`å…³é—­æµ

~~~C
int fclose(FILE *f);
~~~

`fclose`å‡½æ•°åœ¨æ–‡ä»¶å…³é—­å‰åˆ·æ–°ç¼“å†²åŒºã€‚æ‰§è¡ŒæˆåŠŸè¿”å›0å€¼ï¼Œå¦åˆ™è¿”å›EOFã€‚
> æ˜¯å¦åº”è¯¥å¯¹fclose(æˆ–å…¶ä»–æ“ä½œ)è¿›è¡Œé”™è¯¯æ£€æŸ¥ï¼Ÿ
>>
>> 1. å¦‚æœæ“ä½œæˆåŠŸåº”è¯¥æ‰§è¡Œä»€ä¹ˆï¼Ÿ  
>> 2. å¦‚æœæ“ä½œå¤±è´¥åº”è¯¥æ‰§è¡Œä»€ä¹ˆï¼Ÿ
>>
>>> å¦‚æœè¿™ä¸¤ä¸ªç­”æ¡ˆæ˜¯ä¸åŒçš„ï¼Œåº”è¯¥è¿›è¡Œé”™è¯¯æ£€æŸ¥ï¼›å¦‚æœæ˜¯ç›¸åŒçš„ï¼Œè·³è¿‡é”™è¯¯æ£€æŸ¥æ‰æ˜¯åˆç†çš„ã€‚

## 15.8 å­—ç¬¦I/O

å­—ç¬¦è¾“å…¥

~~~C
int fgetc(FILE *stream);
int getc(FILE *stream);
int getchar(void);
~~~

å­—ç¬¦è¾“å‡º

~~~C
int fputc(int character,FILE* stream);
int putc(int character,FILE* stream);
int putchar(int character);
~~~

### 15.8.1 å­—ç¬¦I/Oå®

é™¤äº†`fgetc`å’Œ`fputc`å…¶ä»–éƒ½æ˜¯`#define`æŒ‡ä»¤å®šä¹‰çš„å®ï¼Œä¸¤ç§å®ç°ä¸ºäº†ä¸åŒçš„åœºæ™¯ï¼Œä½†æ˜¯å®é™…ä¸¤ç§æ“ä½œç›¸å·®ç”šå¾®ã€‚

### 15.8.2 æ’¤é”€å­—ç¬¦I/O

åœ¨æµè¯»å–æ—¶æ€»æœ‰ä¸€ä¸ªä¸æƒ³è¯»å–çš„å­—ç¬¦ï¼Œä½†ä½¿ç”¨æµé€ä¸ªè¯»å–æ²¡æœ‰æ¡ä»¶åˆ¤æ–­ä¸€å®šä¼šè¯»åˆ°ä¸€ä¸ªä¸æ»¡è¶³çš„å­—ç¬¦ï¼Œä¸ºäº†ä¸ä¸¢å¼ƒè¿™ä¸ªå­—ç¬¦ï¼Œä½¿ç”¨`ungetc`å‡½æ•°å°†è¿™ä¸ªå­—ç¬¦ä»å‚æ•°ä¸­æ¨å›streamä¸­ã€‚

> `ungetc`å‡½æ•°ä¸»è¦çš„åº”ç”¨åœºæ™¯æ˜¯**è¶…å‰æ‰«æ**æˆ–**ä»¤ç‰Œè§£æ**

è¯»å–ä¸€ä¸ªæ•´æ•°ï¼Œç›´åˆ°é‡åˆ°éæ•°å­—æˆ–EOF

~~~C
#include <stdio.h>
#include <ctype.h> // ç”¨äº isdigit()

// å‡½æ•°ï¼šä»æ ‡å‡†è¾“å…¥è¯»å–ä¸€ä¸ªæ•´æ•°
int read_integer(FILE *stream) {
    int ch;
    int value = 0;

    // 1. è·³è¿‡å¼€å§‹çš„ç©ºç™½å­—ç¬¦
    do {
        ch = fgetc(stream);
    } while (isspace(ch));

    // 2. æ£€æŸ¥ç¬¬ä¸€ä¸ªéç©ºç™½å­—ç¬¦æ˜¯å¦æ˜¯æ•°å­—
    if (!isdigit(ch)) {
        // å¦‚æœç¬¬ä¸€ä¸ªå­—ç¬¦ä¸æ˜¯æ•°å­—ï¼Œå°±æŠŠå®ƒæ”¾å›æµä¸­
        if (ch != EOF) {
            ungetc(ch, stream);
        }
        return 0; // æˆ–è€…è¿”å›ä¸€ä¸ªé”™è¯¯ä»£ç 
    }

    // 3. è¯»å–æ•°å­—éƒ¨åˆ†
    while (isdigit(ch)) {
        value = value * 10 + (ch - '0');
        ch = fgetc(stream); // è¶…å‰è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦
    }

    // 4. ã€æ ¸å¿ƒæ­¥éª¤ã€‘
    // å¾ªç¯åœæ­¢æ˜¯å› ä¸º ch é‡åˆ°äº†ç¬¬ä¸€ä¸ªéæ•°å­—å­—ç¬¦ï¼ˆæˆ–è€… EOFï¼‰ã€‚
    // è¿™ä¸ªéæ•°å­—å­—ç¬¦ï¼ˆä¾‹å¦‚ä¸€ä¸ªå­—æ¯ 'A'ï¼‰ä¸å±äºå½“å‰çš„æ•´æ•°ï¼Œå®ƒå±äºæµçš„ä¸‹ä¸€ä¸ªéƒ¨åˆ†ã€‚
    if (ch != EOF) {
        ungetc(ch, stream); // å°†è¿™ä¸ªè¶…å‰è¯»å–çš„å­—ç¬¦æ”¾å›æµä¸­
    }
    
    return value;
}

int main() {
    int num1, num2;
    
    printf("è¯·è¾“å…¥æ•°æ® (ä¾‹å¦‚: 123ABC456)\n");
    
    // å‡è®¾ç”¨æˆ·è¾“å…¥: 123ABC456\n

    // ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼šè¯»å– 123
    num1 = read_integer(stdin); 
    printf("è¯»å–åˆ°ç¬¬ä¸€ä¸ªæ•´æ•°: %d\n", num1); 
    // æ­¤æ—¶å­—ç¬¦ 'A' è¢« read_integer è¯»èµ°ååˆæ”¾å›äº† stdinã€‚

    // ç¬¬äºŒæ¬¡è°ƒç”¨ï¼šè¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ï¼Œå®ƒå°†æ˜¯ 'A'
    printf("ä¸‹ä¸€ä¸ªå­—ç¬¦æ˜¯: %c\n", fgetc(stdin)); 
    
    // ç¬¬ä¸‰æ¬¡è°ƒç”¨ï¼šè¯»å– 456
    // read_integer ä¼šæ¶ˆè€— 'B', 'C'ï¼Œç›´åˆ° 456
    // num2 = read_integer(stdin); // é”™è¯¯ï¼šä¼šæ¶ˆè€— 'B', 'C'
    
    printf("æµä¸­å‰©ä½™å­—ç¬¦:\n");
    // æ¸…ç©ºå¹¶æ‰“å°å‰©ä½™éƒ¨åˆ†ï¼Œä»¥éªŒè¯ ungetc åçš„å­—ç¬¦ 'A' ç¡®å®è¢«è¯»å–äº†
    int ch;
    while ((ch = getchar()) != EOF) {
        putchar(ch);
    }
    
    return 0;
}
~~~

> é€€å›å­—ç¬¦å’Œæµçš„å½“å‰ä½ç½®æœ‰å…³ï¼Œå¦‚æœä½¿ç”¨`fseek`,`fsetpos`æˆ–`rewind`å‡½æ•°æ”¹å˜äº†æµçš„ä½ç½®ï¼Œæ‰€æœ‰é€€å›çš„å­—ç¬¦éƒ½è¦è¢«ä¸¢å¼ƒã€‚
>
## 15.9 æœªæ ¼å¼åŒ–çš„è¡ŒI/O

è¡ŒI/Oå¯ä»¥ä½¿ç”¨ä¸¤ç§æ–¹å¼æ‰§è¡Œâ€”â€”â€”â€”æœªæ ¼å¼åŒ–çš„å’Œæ ¼å¼åŒ–çš„ã€‚è¿™ä¸¤ç§å½¢å¼éƒ½ç”¨äºæ“ä½œå­—ç¬¦ä¸²ã€‚

~~~C
char *fgets(char* buffer, int buffer_size, FILE *stream);
char *gets(char *buffer);

int fputs(char const *buffer, FILE* stream);
int puts(char const *buffer);
~~~

`fgets`ä»æŒ‡å®šçš„streamè¯»å–å­—ç¬¦å¹¶æŠŠå®ƒä»¬å¤åˆ¶åˆ°bufferä¸­ã€‚åœ¨è¯»å–åˆ°æ¢è¡Œç¬¦æˆ–ç¼“å†²åŒºå†…å­˜å‚¨çš„å­—ç¬¦è¾¾åˆ°`buffer_size - 1`æ—¶åœæ­¢è¯»å–ã€‚

> getsåœ¨C99åä¸æ¨èä½¿ç”¨ï¼ŒC11åå·²ç»å®Œå…¨æŠ›å¼ƒï¼åœ¨ä»»ä½•æƒ…å†µä¸‹`fgets`éƒ½ä¼šåœ¨æœ«å°¾æ·»åŠ NULå­—èŠ‚è¡¨ç¤ºå­—ç¬¦ä¸²ç»“æŸï¼›putsä¼šè‡ªåŠ¨åœ¨å°¾éƒ¨æ·»åŠ æ¢è¡Œç¬¦ï¼›fputsä¸ä¼šæ·»åŠ æ¢è¡Œç¬¦ã€‚

å¸¸è§é”™è¯¯

~~~C
#include <stdio.h>

int main() {
    char data[5];

    // é”™è¯¯æ“ä½œï¼šæ•°ç»„åªæœ‰5ä¸ªå­—èŠ‚ï¼Œä½†å†™å…¥äº†6ä¸ªå­—ç¬¦ï¼Œæ²¡æœ‰ç•™ç©ºé—´ç»™ '\0'
    // å®é™…ä¸Šæ˜¯å†™å…¥äº† 'H', 'e', 'l', 'l', 'o'ï¼Œ'\0' æº¢å‡ºåˆ°äº† data ä¹‹å¤–
    // ä½†åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å‡è®¾ç”¨ memcpy æˆ–å…¶å®ƒæ–¹å¼ç²¾ç¡®åœ°å¡«æ»¡ dataï¼Œæ²¡æœ‰ \0
    data[0] = 'A';
    data[1] = 'B';
    data[2] = 'C';
    data[3] = 'D';
    data[4] = 'E'; // <--- æ•°ç»„å·²æ»¡ï¼Œæ²¡æœ‰ç©ºç»ˆæ­¢ç¬¦

    printf("å°è¯•å†™å…¥ä¸€ä¸ªéç»ˆæ­¢å­—ç¬¦ä¸²...\n");

    // fputs å°†ä¼šä» data[0] å¼€å§‹ä¸€ç›´è¯»åˆ°å†…å­˜ä¸­æ‰¾åˆ° \0 ä¸ºæ­¢
    // è¿™å°†æ˜¯ UBï¼
    fputs(data, stdout); 

    printf("\nç¨‹åºå¯èƒ½å´©æºƒï¼Œæˆ–è€…è¾“å‡ºäº†ä¹±ç ã€‚\n");

    return 0;
}
~~~

> `fgets`ç¬¬äºŒä¸ªå‚æ•°è™½ç„¶èƒ½æŒ‡å®šä¼ å…¥çš„å…ƒç´ ä¸ªæ•°ï¼Œä½†æ˜¯å¦‚æœå‚æ•°è¿‡å¤§æº¢å‡ºå®ƒçš„ç¼“å†²åŒºï¼Œ`fgets`ä¸ä¼šå¼•èµ·é”™è¯¯ã€‚

ä¸€ä¸ªä¾‹å­

~~~C
/*
  æŠŠæ ‡å‡†è¾“å…¥è¯»å–çš„æ–‡æœ¬è¡Œé€è¡Œå¤åˆ¶åˆ°æ ‡å‡†è¾“å‡ºã€‚
*/
#include <stdio.h>

#define MAX_LINE_LENGTH 1024

void copylines(FILE *input, FILE *output)
{
  char buffer[MAX_LINE_LENGTH];
  
  while( fgets(buffer, MAX_LINE_LENGTH, input) != NULL)
    fputs(buffer, output);
}
~~~

## 15.10 æ ¼å¼åŒ–çš„è¡ŒI/O

- â€œæ ¼å¼åŒ–çš„è¡ŒI/Oâ€è¿™ä¸ªåå­—ä»æŸç§æ„ä¹‰ä¸Šå¹¶ä¸å‡†ç¡®ï¼Œå› ä¸º `scanf` å’Œ `printf` å‡½æ•°å®¶æ—å¹¶ä¸ä»…é™äºå•è¡Œã€‚å®ƒä»¬ä¹Ÿå¯ä»¥åœ¨è¡Œçš„ä¸€éƒ¨åˆ†æˆ–å¤šè¡Œä¸Šæ‰§è¡ŒI/Oæ“ä½œã€‚

### 15.10.1 scanfå®¶æ—

~~~C
int fscanf(FILE *stream, char const *format, ...);
int scanf(char const *format, ...);
int sscanf(char const *string, char const *format, ...);
~~~

***å‡½æ•°æ— æ³•éªŒè¯å¯¹åº”çš„æŒ‡é’ˆå‚æ•°è¾“å…¥æ˜¯å¦æ˜¯å¯¹åº”æ ¼å¼ä»£ç çš„æ­£ç¡®ç±»å‹ã€‚å‡½æ•°ä¼šå‡å®šå®ƒä»¬æ˜¯æ­£ç¡®çš„ï¼Œäºæ˜¯ç»§ç»­æ‰§è¡Œå¹¶ä½¿ç”¨å®ƒä»¬ã€‚***

### 15.10.2 scanfæ ¼å¼ä»£ç 

- **ç©ºç™½å­—ç¬¦**â€”â€”â€”â€”ä¸è¾“å…¥ä¸­çš„é›¶ä¸ªæˆ–å¤šä¸ªç©ºç™½å­—ç¬¦ç›¸åŒ¹é…ï¼Œåœ¨å¤„ç†è¿‡ç¨‹ä¸­å°†è¢«å¿½ç•¥ã€‚
- **æ ¼å¼ä»£ç **â€”â€”â€”â€”å®ƒä»¬æŒ‡å®šå‡½æ•°å¦‚ä½•è§£é‡Šæ¥ä¸‹æ¥çš„è¾“å…¥å­—ç¬¦ã€‚
- **å…¶ä»–å­—ç¬¦**â€”â€”â€”â€”å½“ä»»ä½•å…¶ä»–å­—ç¬¦å‡ºç°åœ¨æ ¼å¼å­—ç¬¦ä¸²æ—¶ï¼Œä¸‹ä¸€ä¸ªè¾“å…¥å­—ç¬¦å¿…é¡»ä¸å®ƒåŒ¹é…ã€‚å¦‚æœåŒ¹é…ï¼Œè¯¥è¾“å…¥å­—ç¬¦éšåè¢«ä¸¢å¼ƒï¼›å¦‚æœä¸åŒ¹é…ï¼Œå‡½æ•°å°±ä¸å†è¯»å–ç›´æ¥è¿”å›ã€‚

#### æ ¼å¼ä»£ç æ ¼å¼

- æ ¼å¼ä»£ç éƒ½æ˜¯ä»¥ä¸€ä¸ªç™¾åˆ†å·å¼€å¤´ï¼Œåé¢å¯ä»¥æ˜¯
  - ä¸€ä¸ªå¯é€‰çš„æ˜Ÿå·ï¼ˆèµ‹å€¼æŠ‘åˆ¶ç¬¦ï¼‰
  - ä¸€ä¸ªå¯é€‰çš„å®½åº¦
  - ä¸€ä¸ªå¯é€‰çš„é™å®šç¬¦
  - æ ¼å¼ä»£ç 

- å¯é€‰çš„æ˜Ÿå·å…·ä½“ä½¿ç”¨æ–¹æ³•
å‡è¾“å…¥æµä¸­æœ‰æ•°æ®ï¼š`Item_A: 100, Item_B: 200`

~~~C
int val_b;
// ä½¿ç”¨ %*s è·³è¿‡ "Item_A:"
// ä½¿ç”¨ %*d è·³è¿‡ 100
// ä½¿ç”¨ %*c è·³è¿‡ é€—å·å’Œç©ºæ ¼
// Item_B: é€‰é¡¹è¢«åŒ¹é…åä¸¢å¼ƒ
// åªè¯»å–Item_B çš„å€¼
scanf("%*s %*d, Item_B: %d",&val_b);

// ç»“æœï¼šval_b å°†è¢«èµ‹å€¼ä¸º 200ï¼Œæµä¸­çš„ "Item_A: 100, "éƒ¨åˆ†è¢«è·³è¿‡
~~~

#### scanfé™å®šç¬¦

| é™å®šç¬¦ | ä½œç”¨ (ç”¨äºæŒ‡å®šå‚æ•°å¤§å°) | é€‚ç”¨çš„ç±»å‹ç  | å¯¹åº”çš„ C ç±»å‹ |
| :---: | :--- | :--- | :--- |
| **`h`** | è¯»å–çŸ­æ•´æ•°ï¼ˆHalf word sizeï¼‰ | `d`, `i`, `u`, `o`, `x`, `n` | `short int`, `unsigned short int` |
| **`hh`** | è¯»å–å­—ç¬¦å¤§å°çš„æ•´æ•° | `d`, `i`, `u`, `o`, `x`, `n` | `signed char`, `unsigned char` |
| **`l`** | è¯»å–é•¿æ•´æ•° | `d`, `i`, `u`, `o`, `x`, `n` | `long int`, `unsigned long int` |
| **`ll`** | è¯»å–è¶…é•¿æ•´æ•° | `d`, `i`, `u`, `o`, `x`, `n` | `long long int`, `unsigned long long int` |
| **`l`** | è¯»å–åŒç²¾åº¦æµ®ç‚¹æ•° | `f`, `e`, `g`, `a` | `double` (æ³¨æ„ï¼š`%f` è¯»å– `float`) |
| **`L`** | è¯»å–è¶…é•¿åŒç²¾åº¦æµ®ç‚¹æ•° | `f`, `e`, `g`, `a` | `long double` |
| **`z`** | è¯»å– `size_t` ç±»å‹ï¼ˆæ— ç¬¦å·ï¼‰ | `d`, `i`, `u`, `o`, `x`, `n` | `size_t` |
| **`j`** | è¯»å–æœ€å¤§å®½åº¦æ•´æ•° | `d`, `i`, `u`, `o`, `x`, `n` | `intmax_t`, `uintmax_t` |
| **`t`** | è¯»å–æŒ‡é’ˆå·®å€¼ç±»å‹ | `d`, `i`, `u`, `o`, `x`, `n` | `ptrdiff_t` |

ä¸€ä¸ªä¸èƒ½æ€»æ˜¯æ­£ç¡®æ¥æ”¶å‚æ•°çš„`fscanf()`

~~~C
  int a, b, c;
  a = b = c = 0;
  FILE *f = (FILE *)fopen("./test.txt", "r+");
  FILE *f1 = (FILE *)fopen("./testout.txt", "r+");
  if (f == NULL || f1 == NULL) {
    perror("Failed to read from stream test.txt.\n");
    return EXIT_FAILURE;
  }

  if (fscanf(f, "%d %d", &a, &b) ==
      2) { // è¿™é‡Œå¦‚æœæ¥æ”¶çš„ä¸æ˜¯ä¸¤ä¸ªæ•´å‹å˜é‡å°±ä¼šå¯¼è‡´å¾ªç¯ç»ˆæ­¢ï¼Œä¸”fscanfè·³è¿‡ç©ºç™½å­—ç¬¦ï¼Œ
           // æ‰€ä»¥å®ƒæ²¡æœ‰åŠæ³•éªŒè¯è¿™ä¸¤ä¸ªå€¼æ˜¯ä½äºåŒä¸€è¡Œè¿˜æ˜¯åˆ†å±äºä¸¤ä¸ªä¸åŒçš„è¾“å…¥è¡Œ
    fprintf(stdout, "Two number i got from stream f to stdout is %d - %d\n", a,
            b);
  }

  // é‡ç½®æ–‡ä»¶æŒ‡é’ˆåˆ°æ–‡ä»¶å¼€å¤´
  rewind(f);

  int nfield = fscanf(f, "%4d %4d %4d", &a, &b, &c);
  if (nfield == 2)
    fprintf(f1, "Two number i got from stream f to f1 is %d - %d", a, b);
  else if (nfield == 3)
    fprintf(f1, "Three number i got from stream f to f1 is %d - %d - %d", a, b,
            c);

  fclose(f1);
  fclose(f); 
~~~

ä¸€ä¸ªæ›´ä¸ºå¯é çš„æ–¹æ³•è¯»å–è¿™ç§ç±»å‹çš„`fscanf()`

~~~C
#include <stdio.h>

#define BUFFER_SIZE 100

void function(FILE *input)
{
  int a, b, c, d, e;
  char buffer[BUFFER_SIZE];
  
  while (fgets(buffer, BUFFER_SIZE, input) != NULL){
    if (sscanf(buffer,"%d %d %d %d %d", &a, &b, &c, &d, &e) != 4)
    {
      fprintf(stderr,"Bad input skipped: %s", buffer);
      continue;
    }
  }
  // å¤„ç†è¿™ç»„è¾“å…¥
}
~~~

### 15.10.3 printfå®¶æ—

~~~C
int fprintf(FILE *stream, char const *format, ...);
int printf(char const *format, ...);
int sprintf(char *buffer, char const *format, ...);
~~~

> `sprintf()`è¢«è®¤ä¸ºæ˜¯æœ‰ç¼ºé™·çš„(ä¸å®‰å…¨çš„)ï¼Œä¸»è¦å› ä¸ºå®ƒå­˜åœ¨å›ºæœ‰çš„ç¼“å†²åŒºæº¢å‡º(Buffer Overflow)é£é™©ã€‚
>
> å½“ bufferè¢«è®¾ç½®ä¸ºä¸€ä¸ªå›ºå®šå¤§å°çš„ç¼“å†²åŒºæ—¶ä¼šæœ‰å¯èƒ½è¶…å‡ºé™åˆ¶ï¼Œä¸”æ— æ³•é˜»æ­¢å…¶**ç»§ç»­è¦†ç›–ç›¸é‚»çš„å†…å­˜**ã€‚
>> C99 æ ‡å‡†å¼•å…¥äº† `snprintf` è§£å†³`sprintf`çš„å®‰å…¨é—®é¢˜ã€‚

~~~C
int snprintf(char *str, size_t size, const char *format, ...);
~~~

### 15.10.4 printf æ ¼å¼ä»£ç 

**`printf`å®¶æ—æ ¼å¼ä»£ç å’Œ`scanf`æ ¼å¼ä»£ç ç±»ä¼¼**

å‡ ä¸ªä½¿ç”¨`printf`æ ¼å¼ä»£ç çš„ä¾‹å­

1. ç”¨`printf`æ ¼å¼å­—ç¬¦ä¸²

|æ ¼å¼ä»£ç |è½¬æ¢åçš„å­—ç¬¦ä¸²|||
|:---:|:---:|:---:|:---:|
|%s|A|ABC|ABCDEFGH|
|%5s|[][][][]A|[][]ABC|ABCDEFGH|
|%.5s|A|ABC|ABCDE|
|%5.5s|[][][][]A|[][]ABC|ABCDE|
|%-5s|A[][][][]|ABC[][]|ABCDEFGH|

> `%.5s` ä¸­çš„`.5`æ˜¯é™åˆ¶ç²¾åº¦(é™åˆ¶å­—ç¬¦æ•°)ï¼Œ`%.5d`ä¸­çš„`.5`æ˜¯é™åˆ¶å®½åº¦çš„ï¼Œè€Œ`%5d`æ˜¯é™åˆ¶ç²¾åº¦(é™åˆ¶æ•°å­—ä½æ•°)ã€‚

2. ç”¨`printf`æ ¼å¼åŒ–æ•´æ•°

|æ ¼å¼ä»£ç |è½¬æ¢åçš„æ•°å€¼||||
|:---:|:---:|:---:|:---:|:---:|
|%d|1|-12|12345|123456789|
|%6d|[][][][][]1|[][][]-12|[]12345|123456789|
|%.4d|0001|-0012|12345|123456789|
|%6.4d|[][]0001|[]-0012|[]12345|123456789|
|%-4d|1[][][][]|-12[]|12345|123456789|
|%04d|0001|-012|12345|123456789|
|%+d|+1|-12|+12345|+123456789|

3. ç”¨`printf`æ ¼å¼åŒ–æµ®ç‚¹æ•°

|æ ¼å¼ä»£ç |è½¬æ¢åçš„æ•°å€¼||||
|:---:|:---:|:---:|:---:|:---:|
||1|.01|.00012345|12345.6789|
|%f|1.000000|0.010000|0.000123|12345.678900|
|%10.2f|[][][][][][]1.00|[][][][][][]0.01|[][][][][][]0.00|[][]12345.67|
|%e|1.000000e+00|1.000000e-02|1.234500e-04|1.234568e+04|
|%.4e|1.0000e+00|1.0000e-02|1.2345e-04|1.2346e+04|
|%g|1|0.01|0.00012345|12345.7|

4. ç”¨`printf`æ ¼å¼åŒ–å¤§æµ®ç‚¹å€¼

|æ ¼å¼ä»£ç |è½¬æ¢åçš„æ•°å€¼|
|:---:|:---:|
||6.023e23|
|%f|6.02299999999999975882752.000000|
|%10.2f|6.02299999999999975882752.000000|
|%e|6.023000e+23|
|%.4e|6.0230e+23|
|%g|6.023e+23|

## 15.11 äºŒè¿›åˆ¶I/O

- æŠŠæ•°æ®å†™åˆ°æ–‡ä»¶æ•ˆç‡æœ€é«˜çš„æ–¹æ³•æ˜¯ç”¨äºŒè¿›åˆ¶å½¢å¼å†™å…¥ã€‚äºŒè¿›åˆ¶è¾“å‡º**é¿å…äº†åœ¨æ•°å€¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²è¿‡ç¨‹ä¸­æ‰€æ¶‰åŠçš„å¼€é”€å’Œç²¾åº¦æŸå¤±**ã€‚ä½†äºŒè¿›åˆ¶æ•°æ®å¹¶éäººçœ¼æ‰€èƒ½é˜…è¯»ï¼Œæ‰€ä»¥è¿™ä¸ªæŠ€å·§åªæœ‰**å½“æ•°æ®å°†è¢«å¦ä¸€ä¸ªç¨‹åºæŒ‰é¡ºåºè¯»å–æ—¶**æ‰èƒ½ä½¿ç”¨ã€‚

`fread`å‡½æ•°ç”¨äºè¯»å–äºŒè¿›åˆ¶æ•°æ®ï¼Œ`fwrite`å‡½æ•°ç”¨äºå†™å…¥äºŒè¿›åˆ¶æ•°æ®ã€‚

~~~C
size_t fread(void *buffer, size_t size, size_t count, FILE *stream);
size_t fwrite(void *buffer, size_t size, size_t count, FILE* stream);
~~~

`buffer`æ˜¯ä¸€ä¸ªæŒ‡å‘ç”¨äºä¿å­˜æ•°æ®çš„å†…å­˜ä½ç½®çš„æŒ‡é’ˆï¼Œ`size`æ˜¯ç¼“å†²åŒºä¸­æ¯ä¸ªå…ƒç´ çš„å­—èŠ‚æ•°ï¼Œ`count`æ˜¯è¯»å–æˆ–å†™å…¥çš„å…ƒç´ æ•°ï¼Œå½“ç„¶`stream`æ˜¯æ•°æ®è¯»å–æˆ–å†™å…¥çš„æµã€‚

ä¸€ä¸ªä¾‹å­

~~~C
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// 1. å®šä¹‰ä¸€ä¸ªå­˜å‚¨æ•°æ®çš„ç»“æ„ä½“
typedef struct {
  int id;
  char name[20];
  float salary;
} Employee;

// è¾…åŠ©å‡½æ•°ï¼šæ‰“å°ç»“æ„ä½“å†…å®¹
void print_employee(const Employee *e) // const *ç±»å‹ æŒ‡å‘å¸¸é‡çš„æŒ‡é’ˆ
{
  fprintf(stdout, "ID: %d, Name: %-20s, Salary: %.2f\n", e->id, e->name,
          e->salary);
}

// å®šä¹‰æ–‡ä»¶å
#define DATA_FILE "employees.bin"

int main(void) {
  // 2. å‡†å¤‡æ•°æ®ï¼šä¸€ä¸ªç»“æ„ä½“æ•°ç»„
  Employee staff_data[] = {{101, "Alice Johnson", 60000.00f},
                           {102, "Bob Smith", 75000.50f},
                           {103, "Charlie Brown", 50000.25f}};
  const size_t num_employees = sizeof(staff_data) / sizeof(Employee);

  // ------------------------------------------------------------------------
  // ç¬¬ä¸€æ­¥ï¼šä½¿ç”¨ fwrite å°†ç»“æ„ä½“æ•°ç»„å†™å…¥æ–‡ä»¶ï¼ˆè¾“å‡ºæµï¼‰
  // ------------------------------------------------------------------------

  FILE *output_file = fopen(DATA_FILE, "wb"); // write binary
  if (output_file == NULL) {
    perror("Error opening output file");
    return EXIT_FAILURE;
  }

  // fwrite(ptr, size, count, stream)
  // ptr: è¦å†™å…¥çš„æ•°æ®å—çš„èµ·å§‹åœ°å€
  // size: æ¯ä¸ªæ•°æ®å—çš„å¤§å°ï¼ˆè¿™é‡Œæ˜¯ Employee ç»“æ„ä½“çš„å¤§å°ï¼‰
  // count: è¦å†™å…¥çš„æ•°æ®å—çš„æ•°é‡ï¼ˆè¿™é‡Œæ˜¯æ•°ç»„å…ƒç´ çš„æ•°é‡ï¼‰
  // stream: æ–‡ä»¶æµæŒ‡é’ˆ

  size_t written_count =
      fwrite(staff_data, sizeof(Employee), num_employees, output_file);

  if (written_count == num_employees) {
    fprintf(stdout, "æˆåŠŸå°† %zu ä¸ª Employee è®°å½•å†™å…¥æ–‡ä»¶ï¼š%s\n", written_count,
            DATA_FILE);
  } else {
    fprintf(stderr, "è­¦å‘Šï¼šå†™å…¥å¤±è´¥æˆ–éƒ¨åˆ†å¤±è´¥ã€‚\n");
  }

  fclose(output_file);

  // ------------------------------------------------------------------------
  // ç¬¬äºŒæ­¥ï¼šä½¿ç”¨ fread ä»æ–‡ä»¶ä¸­è¯»å–ç»“æ„ä½“æ•°ç»„ï¼ˆè¾“å…¥æµï¼‰
  // ------------------------------------------------------------------------

  FILE *input_file = fopen(DATA_FILE, "rb"); // read binary
  if (input_file == NULL) {
    perror("Error opening input file for reading");
    return EXIT_FAILURE;
  }

  // 3. å‡†å¤‡æ¥æ”¶æ•°æ®çš„ç¼“å†²åŒºï¼ˆåˆ›å»ºä¸€ä¸ªæ–°çš„æ•°ç»„æ¥å­˜å‚¨è¯»å–çš„æ•°æ®ï¼‰
  Employee read_data[num_employees];

  fprintf(stdout, "\nä»æ–‡ä»¶è¯»å–æ•°æ®å¹¶è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º(stdout)ï¼š\n");
  printf("--------------------------------------------------------\n");

  // fread(ptr, size, count, stream)
  // ptr: å­˜å‚¨è¯»å–æ•°æ®çš„å†…å­˜åœ°å€
  // size: æ¯ä¸ªæ•°æ®å—çš„å¤§å°ï¼ˆè¿™é‡Œæ˜¯ Employee ç»“æ„ä½“çš„å¤§å°ï¼‰
  // count: å°è¯•è¯»å–çš„æ•°æ®å—çš„æ•°é‡
  // stream: æ–‡ä»¶æµæŒ‡é’ˆ
  size_t read_count =
      fread(read_data, sizeof(Employee), num_employees, input_file);

  if (read_count == num_employees) {
    printf("æˆåŠŸè¯»å– %zu ä¸ª Employee è®°å½•ã€‚\n", read_count);

    // 4. å°†è¯»å–åˆ°çš„ç»“æ„ä½“æ•°ç»„å…ƒç´ è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º
    for (size_t i = 0; i < read_count; i++) {
      printf("Record %zu: ", i + 1);
      print_employee(&read_data[i]);
    }
  } else {
    fprintf(stderr, "è­¦å‘Šï¼šå°è¯•è¯»å– %zu ä¸ªè®°å½•ï¼Œä½†åªè¯»å–äº† %zu ä¸ªã€‚\n",
            num_employees, read_count);
  }

  fclose(input_file);

  // æ¸…ç†åˆ›å»ºçš„æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
  // remove(DATA_FILE);

  return EXIT_SUCCESS;
}
~~~

## 15.12 åˆ·æ–°å’Œå®šä½æ•°æ®

å½“æˆ‘ä»¬éœ€è¦ç«‹å³æŠŠè¾“å‡ºç¼“å†²åŒºçš„æ•°æ®è¿›è¡Œç‰©ç†å†™å…¥æ—¶ï¼Œåº”è¯¥ä½¿ç”¨`fflush`è¿™ä¸ªå‡½æ•°ã€‚ä¾‹å¦‚ï¼Œè°ƒç”¨`fflush`å‡½æ•°ä¿è¯è°ƒè¯•ä¿¡æ¯å®é™…æ‰“å°å‡ºæ¥ï¼Œè€Œä¸æ˜¯ä¿å­˜åœ¨ç¼“å†²åŒºä¸­ç›´åˆ°ä»¥åæ‰æ‰“å°ã€‚

~~~C
int fflush(FILE *stream);
~~~

åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ•°æ®ä»¥çº¿æ€§çš„æ–¹å¼å†™å…¥ï¼Œè¿™æ„å‘³ç€åé¢å†™å…¥çš„æ•°æ®åœ¨æ–‡ä»¶ä¸­çš„ä½ç½®æ˜¯åœ¨ä»¥å‰æ‰€æœ‰å†™å…¥æ•°æ®çš„åé¢ã€‚CåŒæ—¶æ”¯æŒéšæœºè®¿é—®I/Oï¼Œä¹Ÿå°±æ˜¯ä»¥ä»»æ„é¡ºåºè®¿é—®æ–‡ä»¶çš„ä¸åŒä½ç½®ã€‚
`ftell`å’Œ`fseek`å‡½æ•°æ”¯æŒä¸Šé¢çš„æ“ä½œã€‚

~~~C
long ftell(FILE *stream);
int fseek(FILE *stream, long offset, int from);
~~~

`ftell`è¿”å›æµçš„å½“å‰ä½ç½®ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸‹ä¸€ä¸ªè¯»å–æˆ–å†™å…¥å°†è¦å¼€å§‹çš„ä½ç½®è·ç¦»æ–‡ä»¶èµ·å§‹ä½ç½®çš„åç§»é‡(offset)ã€‚è¿™ä¸ªå‡½æ•°å…è®¸ä½ ä¿å­˜ä¸€ä¸ªæ–‡ä»¶çš„å½“å‰ä½ç½®ï¼Œè¿™æ ·ä½ å¯èƒ½åœ¨å°†æ¥å›åˆ°è¿™ä¸ªä½ç½®ã€‚åœ¨äºŒè¿›åˆ¶æµä¸­è¿™ä¸ªå€¼å°±æ˜¯å½“å‰ä½ç½®è·ç¦»æ–‡ä»¶å…¶å®ä½ç½®ä¹‹é—´çš„å­—èŠ‚æ•°ã€‚

åœ¨æ–‡æœ¬æµä¸­è¿™ä¸ªå€¼è¡¨ç¤ºä¸€ä¸ªä½ç½®ï¼Œä½†å®ƒå¹¶ä¸ä¸€å®šå‡†ç¡®åœ°è¡¨ç¤ºå½“å‰ä½ç½®å’Œæ–‡ä»¶èµ·å§‹ä½ç½®ä¹‹é—´çš„å­—ç¬¦æ•°ï¼Œå› ä¸ºæœ‰äº›ç³»ç»Ÿå°†å¯¹è¡Œæœ«å­—ç¬¦è¿›è¡Œç¿»è¯‘è½¬æ¢ã€‚ä½†æ˜¯ï¼Œ`ftell`å‡½æ•°è¿”å›çš„å€¼æ€»æ˜¯å¯ä»¥ç”¨äº`fseek`å‡½æ•°ä¸­ï¼Œä½œä¸ºä¸€ä¸ªè·ç¦»æ–‡ä»¶èµ·å§‹ä½ç½®çš„åç§»é‡ã€‚

`fseek`å‡½æ•°è¿è¡Œä½ åœ¨ä¸€ä¸ªæµä¸­å®šä½ã€‚è¿™ä¸ªæ“ä½œå°†æ”¹å˜ä¸‹ä¸€ä¸ªè¯»å–æˆ–å†™å…¥æ“ä½œçš„ä½ç½®ã€‚å®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯éœ€è¦æ”¹å˜çš„æµï¼Œç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªå‚æ•°æ ‡è¯†æ–‡ä»¶ä¸­éœ€è¦å®šä½çš„ä½ç½®ã€‚

è¯•å›¾å®šä½åˆ°ä¸€ä¸ªæ–‡ä»¶çš„èµ·å§‹ä½ç½®ä¹‹å‰æ˜¯ä¸€ä¸ªé”™è¯¯ã€‚å®šä½åˆ°æ–‡ä»¶å°¾ä¹‹åå¹¶è¿›è¡Œå†™å…¥å°†æ‰©å±•è¿™ä¸ªæ–‡ä»¶ã€‚å®šä½åˆ°æ–‡ä»¶å°¾ä¹‹åå¹¶è¿›è¡Œè¯»å–å°†å¯¼è‡´è¿”å›ä¸€æ¡â€œåˆ°è¾¾æ–‡ä»¶å°¾â€çš„ä¿¡æ¯ã€‚åœ¨äºŒè¿›åˆ¶æµä¸­ï¼Œä»**SEEK_END**è¿›è¡Œå®šä½å¯èƒ½ä¸è¢«æ”¯æŒï¼Œæ‰€ä»¥åº”è¯¥é¿å…ã€‚åœ¨æ–‡æœ¬æµä¸­ï¼Œå¦‚æœfromæ˜¯**SEEK_CUR**æˆ–**SEEK_END**ï¼Œoffsetå¿…é¡»æ˜¯é›¶ã€‚å¦‚æœfromæ˜¯**SEEK_SET**ï¼Œoffsetå¿…é¡»æ˜¯ä¸€ä¸ªä»åŒä¸€ä¸ªæµä¸­ä»¥å‰è°ƒç”¨`ftell`æ‰€è¿”å›çš„å€¼ã€‚

|å¦‚æœfromæ˜¯|ä½ å°†å®šä½åˆ°...|
|:---:|:---:|
|SEEK_SET|ä»æµçš„èµ·å§‹ä½ç½®èµ·offsetä¸ªå­—èŠ‚ï¼Œoffsetå¿…é¡»æ˜¯ä¸€ä¸ªéè´Ÿå€¼|
|SEEK_CUR|ä»æµçš„å½“å‰ä½ç½®èµ·offsetä¸ªå­—èŠ‚ï¼Œoffsetå¯æ­£å¯è´Ÿ|
|SEEK_END|ä»æµçš„å°¾éƒ¨ä½ç½®èµ·offsetä¸ªå­—èŠ‚ï¼Œoffsetå¯æ­£å¯è´Ÿã€‚å¦‚æœæ˜¯æ­£å€¼å®ƒå°†å®šä½åˆ°æ–‡ä»¶å°¾çš„åé¢|

å¦å¤–è¿˜æœ‰ä¸‰ä¸ªé¢å¤–çš„å‡½æ•°ï¼Œç”¨ä¸€äº›é™åˆ¶æ›´ä¸¥çš„æ–¹å¼æŒ‡æ‰§è¡Œç›¸åŒçš„ä»»åŠ¡ã€‚

~~~C
void rewind(FILE *stream);
int fgetpos(FILE *stream, fpos_t *position);
int fsetpos(FILE *stream, fpos_t const *position);
~~~

`rewind`å‡½æ•°å°†è¯»/å†™æŒ‡é’ˆè®¾ç½®å›æŒ‡å®šæµçš„èµ·å§‹ä½ç½®ã€‚å®ƒåŒæ—¶æ¸…é™¤æµçš„é”™è¯¯æç¤ºæ ‡å¿—ã€‚`fgetpos`å’Œ`fsetpos`å‡½æ•°åˆ†åˆ«æ˜¯`ftell`å’Œ`fseek`å‡½æ•°çš„æ›¿ä»£æ–¹æ¡ˆã€‚

å®ƒä»¬çš„ä¸»è¦åŒºåˆ«åœ¨äºè¿™å¯¹å‡½æ•°æ¥å—ä¸€ä¸ªæŒ‡å‘`fpos_t`çš„æŒ‡é’ˆä½œä¸ºå‚æ•°ã€‚`fgetpos`åœ¨è¿™ä¸ªä½ç½®å­˜å‚¨æ–‡ä»¶çš„å½“å‰ä½ç½®ï¼Œ`fsetpos`æŠŠæ–‡ä»¶ä½ç½®è®¾ç½®ä¸ºå­˜å‚¨åœ¨è¿™ä¸ªä½ç½®çš„å€¼ã€‚

ä¸€ä¸ªä½¿ç”¨è¿™äº›å®šä½å‡½æ•°çš„ä¾‹å­

~~~C
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define FILENAME "demo_file.txt"

int main(void) {
  FILE *fp;

  // ===================================================================
  // 1. æ‰“å¼€æ–‡ä»¶å¹¶å†™å…¥æ•°æ® (ä½¿ç”¨ "w+" æ¨¡å¼å…è®¸è¯»å†™)
  // ===================================================================

  fp = fopen(FILENAME, "w+");
  if (fp == NULL) {
    perror("Error opening file");
    return EXIT_FAILURE;
  }

  printf("--- å¼€å§‹å†™å…¥å’Œæ§åˆ¶æ–‡ä»¶æŒ‡é’ˆ ---\n");

  // å†™å…¥ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²
  fputs("ABCDEFGHIJKLMNOP", fp);
  printf("1. å†™å…¥ 'ABCDEFGHIJKLMNOP'\n");

  // -- fflush ç¤ºä¾‹ --
  // å°½ç®¡æ²¡æœ‰æ¢è¡Œç¬¦ï¼Œfflush ä¹Ÿä¼šå¼ºåˆ¶å°†æ•°æ®ä»ç¼“å†²åŒºå†™å…¥ç£ç›˜
  fflush(fp); // fputsæ²¡æœ‰å†™å…¥æ¢è¡Œç¬¦ï¼Œè¿™é‡Œæœ¬æ¥fputsçš„
              // ç¬¬ä¸€ä¸ªå‚æ•°å†™å…¥åˆ°ç¼“å†²åŒºè¿˜æœªåˆ°fpä¸­ï¼Œä½†æ˜¯
              // æ‰§è¡Œfflushå¯ä»¥å¼ºåˆ¶ä»ç¼“å†²åŒºå†™å…¥ç£ç›˜
  printf("2. ä½¿ç”¨fflush å¼ºåˆ¶åˆ·æ–°æ•°æ®åˆ°æ–‡ä»¶ã€‚\n");

  // -- ftell å’Œ fgetpos ç¤ºä¾‹ --

  long initial_pos = ftell(fp); // è®°å½•å½“å‰ä½ç½® ï¼ˆé€šå¸¸æ˜¯16ï¼Œå³å­—ç¬¦ä¸²æœ«å°¾ï¼‰
  fpos_t saved_fpos;
  fgetpos(fp, &saved_fpos); // è®°å½•å½“å‰ä½ç½®åˆ° fpos_t ç»“æ„ä½“ä¸­

  printf("3. å½“å‰æ–‡ä»¶æŒ‡é’ˆä½ç½®(ftell): %ld\n", initial_pos);

  // å†™å…¥ç¬¬äºŒä¸ªå­—ç¬¦ä¸²
  fputs("XYZ", fp);
  printf("4. å†™å…¥ 'XYZ'ã€‚\n");

  // -- fssek ç¤ºä¾‹ --
  // fseek(stream, offset, origin);
  // origin: SEEK_SET ä»æ–‡ä»¶å¼€å¤´ï¼Œ SEEK_CUR ä»å½“å‰ä½ç½®ï¼ŒSEEK_END ä»æ–‡ä»¶æœ«å°¾

  // å°†æŒ‡é’ˆ é‡æ–°å®šä½åˆ°ç¬¬äº”ä¸ªå­—ç¬¦(ç´¢å¼•5)
  fseek(fp, 5, SEEK_SET);
  printf("5. ä½¿ç”¨ fseek(5, SEEK_SET) è·³è½¬åˆ°ç´¢å¼•5ã€‚\n");

  // å†™å…¥æ–°æ•°æ® ï¼Œä¼šè¦†ç›–æ‰åŸæœ‰çš„ 'FGHI'
  fputs("1234", fp);
  printf("6. å†™å…¥ '1234' (è¦†ç›–æ‰åŸæœ‰çš„ 'FGHI').\n");

  // -- fsetpos ç¤ºä¾‹ --

  // å°†æŒ‡é’ˆé‡æ–°å®šä½å›ä¹‹å‰ fgetpos è®°å½•çš„ä½ç½® (initial_pos = 16)
  fsetpos(fp, &saved_fpos);
  printf("7. ä½¿ç”¨ fsetpos è·³è½¬å›ä¿å­˜çš„ä½ç½®(%ld)ã€‚\n", initial_pos);

  // å†™å…¥æ•°æ®ï¼Œä¼šåœ¨ 16 å¤„ ç»§ç»­ å†™å…¥
  fputs("999", fp);
  printf("8. å†™å…¥'999'ã€‚\n");

  // --- rewind ç¤ºä¾‹ ---
  rewind(fp);
  printf("9. ä½¿ç”¨ rewind å°†æŒ‡é’ˆ é‡ç½®åˆ°æ–‡ä»¶å¼€å¤´ã€‚\n");

  // ===================================================================
  // 2. ä»å¼€å¤´è¯»å–æœ€ç»ˆæ–‡ä»¶å†…å®¹
  // ===================================================================

  printf("\n--- è¯»å–æ–‡ä»¶å†…å®¹è¿›è¡ŒéªŒè¯ ---\n");
  char buffer[50];

  // å°è¯•ä»å¤´è¯»å–æ•´ä¸ªæ–‡ä»¶
  if (fgets(buffer, sizeof(buffer), fp) != NULL)
    printf("æ–‡ä»¶æœ€ç»ˆå†…å®¹ï¼š%s\n", buffer);
  else
    printf("è¯»å–æ–‡ä»¶å¤±è´¥\n");

  fclose(fp);

  return EXIT_SUCCESS;
}
~~~

## 15.13 æ”¹å˜ç¼“å†²æ–¹å¼

ä¸¤ç§æ”¹å˜æµç¼“å†²æ–¹å¼çš„å‡½æ•°

~~~C
void setbuf(FILE* stream, char *buf);
int setvbuf(FILE* stream, char *buf, int mode, size_t size);
~~~

`setbuf` è®¾ç½®äº†å¦ä¸€ä¸ªæ•°ç»„ï¼Œç”¨äºå¯¹æµè¿›è¡Œç¼“å†²ã€‚è¿™ä¸ªæ•°ç»„çš„å­—ç¬¦é•¿åº¦å¿…é¡»ä¸ºBUFSIZ(åœ¨stdio.hä¸­å®šä¹‰)ã€‚ä¸ºä¸€ä¸ªæµè‡ªè¡ŒæŒ‡å®šç¼“å†²åŒºå¯ä»¥é˜²I/Oå‡½æ•°åº“ä¸ºå®ƒåŠ¨æ€åˆ†é…ä¸€ä¸ªç¼“å†²åŒºã€‚å¦‚æœç”¨ä¸€ä¸ªNULLå‚æ•°è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œ`setbuf`å‡½æ•°å°†å…³é—­æµçš„æ‰€æœ‰ç¼“å†²æ–¹å¼ã€‚å­—ç¬¦å‡†ç¡®åœ°å°†ç¨‹åºæ‰€è§„å®šçš„æ–¹å¼è¿›è¡Œè¯»å–å’Œå†™å…¥ã€‚

> ä¸€ä¸ªæµç¼“å†²åŒºä½¿ç”¨ä¸€ä¸ªè‡ªåŠ¨æ•°ç»„æ˜¯å¾ˆå±é™©çš„ã€‚

`setvbuf`å‡½æ•°æ›´ä¸ºé€šç”¨ã€‚`mode`å‚æ•°ç”¨äºæŒ‡å®šç¼“å†²çš„ç±»å‹ã€‚**_IONBF**æŒ‡å®šä¸€ä¸ªä¸ç¼“å†²çš„æµï¼Œ**_IOLBF**æŒ‡å®šä¸€ä¸ªè¡Œç¼“å†²æµï¼Œ**_IOLBF**æŒ‡å®šä¸€ä¸ªè¡Œç¼“å†²æµã€‚æ‰€è°“è¡Œç¼“å†²ï¼Œå°±æ˜¯æ¯å½“ä¸€ä¸ªæ¢è¡Œç¬¦å†™å…¥åˆ°ç¼“å†²åŒºæ—¶ï¼Œç¼“å†²åŒºä¾¿è¿›è¡Œåˆ·æ–°ã€‚

`buf`å’Œ`size`å‚æ•°ç”¨äºæŒ‡å®šéœ€è¦ä½¿ç”¨çš„ç¼“å†²åŒºã€‚å¦‚æœ`buf`ä¸ºNULLï¼Œé‚£ä¹ˆ`size`çš„å€¼å¿…é¡»æ˜¯0ã€‚
ä¸€èˆ¬è€Œè¨€ï¼Œæœ€å¥½ç”¨ä¸€ä¸ªé•¿åº¦ä¸ºBUFSIZçš„å­—ç¬¦æ•°ç»„ä½œä¸ºç¼“å†²åŒºã€‚

ä¸€ä¸ªä¾‹å­

~~~C
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define FILENAME "big_buffer_test.txt"
#define CUSTOM_BUF_SIZE 4096 * 4 // 16 KB çš„ç¼“å†²åŒºå¤§å°

int main(void) {
  FILE *fp;
  char custom_buffer[CUSTOM_BUF_SIZE]; // å£°æ˜è‡ªå®šä¹‰çš„å†…å­˜ç¼“å†²åŒº

  // 1. æ‰“å¼€æ–‡ä»¶è¿›è¡Œå†™å…¥
  fp = fopen(FILENAME, "w");
  if (fp == NULL) {
    perror("Error opening file.");
    return EXIT_FAILURE;
  }

  // 2. ä½¿ç”¨ setvbuf è®¾ç½®ä¸ºå…¨ç¼“å†²æ¨¡å¼ï¼Œ å¹¶æŒ‡å®šè‡ªå®šä¹‰ç¼“å†²åŒº
  // ç›®æ ‡ï¼šåªæœ‰å½“ 16KB ç¼“å†²åŒºå†™æ»¡æ—¶ï¼Œæ‰è¿›è¡Œä¸€æ¬¡ç£ç›˜å†™å…¥æ“ä½œ
  int result = setvbuf(fp, custom_buffer, _IOFBF, CUSTOM_BUF_SIZE);

  if (result != 0) {
    fprintf(stderr, "setvbuf è®¾ç½®å¤±è´¥!\n");
    fclose(fp);
    return EXIT_FAILURE;
  }

  printf("æ–‡ä»¶æµå·²è®¾ç½®ä¸º %zu å­—èŠ‚çš„å…¨ç¼“å†²æ¨¡å¼ã€‚\n", (size_t)CUSTOM_BUF_SIZE);

  // 3. å†™å…¥æ•°æ®
  for (int i = 0; i < 100; i++) {
    fprintf(fp, "Line %d : This is buffered data.\n", i);
  }

  printf("æ•°æ®å·²å†™å…¥ç¼“å†²åŒºï¼Œä½†å¯èƒ½å°šæœªå†™å…¥ç£ç›˜ã€‚\n");
  // æ­¤æ—¶ï¼Œæ•°æ®ä»åœ¨å†…å­˜ä¸­çš„ custom_buffer ä¸­ï¼Œç›´åˆ°ç¼“å†²åŒºæ»¡æˆ–å…³é—­ã€‚

  // 4. å…³é—­æ–‡ä»¶(å…³é—­æ—¶ä¼šè‡ªåŠ¨å†²åˆ·ç¼“å†²åŒº)
  fclose(fp);
  printf("æ–‡ä»¶å·²å…³é—­ï¼Œç¼“å†²åŒºå†…å®¹å·²å†²åˆ·åˆ°ç£ç›˜ã€‚\n");

  // remove(FILENAME); // æ¸…ç†åŸæ–‡ä»¶(å¯é€‰)

  return EXIT_FAILURE;
}
~~~

## 15.14 æµé”™è¯¯å‡½æ•°

ä¸‹é¢çš„å‡½æ•°ç”¨äºåˆ¤æ–­å’Œç®¡ç†æµçš„çŠ¶æ€

~~~C
int feof(FILE *stream);
int ferror(FILE *stream);
void clearerr(FILE* stream);
~~~

å¦‚æœæµå½“å‰å¤„äºæ–‡ä»¶å°¾ï¼Œ`feof`å‡½æ•°è¿”å›çœŸã€‚è¿™ä¸ªçŠ¶æ€å¯ä»¥é€šè¿‡å¯¹æµæ‰§è¡Œ`fseek`ã€`rewind`æˆ–`fsetpos`å‡½æ•°æ¥æ¸…é™¤ã€‚`ferror`å‡½æ•°æŠ¥å‘Šæµçš„é”™è¯¯çŠ¶æ€ï¼Œå¦‚æœå‡ºç°ä»»ä½•è¯»/å†™é”™è¯¯å‡½æ•°å°±è¿”å›çœŸã€‚æœ€å`clearerr`å‡½æ•°å¯¹æŒ‡å®šæµçš„é”™è¯¯æ ‡å¿—è¿›è¡Œé‡ç½®ã€‚

ä¸€ä¸ªä¾‹å­

~~~C
#include <stdio.h>
#include <stdlib.h>

#define FILENAME "status_demo.txt"

// è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥å¹¶æŠ¥å‘Šæ–‡ä»¶çŠ¶æ€
void report_status(FILE *fp, const char *message);

int main(void) {
  FILE *fp = NULL;
  int c;

  // 1. åˆ›å»ºå¹¶åˆå§‹åŒ–æ–‡ä»¶
  fp = fopen(FILENAME, "w");
  if (fp == NULL)
    return EXIT_FAILURE;
  fputs("Hello C I/O.\n", fp);
  fclose(fp);

  // ===================================================================
  // æ­¥éª¤ A: æ­£å¸¸è¯»å–ç›´åˆ° EOF (feof ç¤ºä¾‹)
  // ===================================================================

  fp = fopen(FILENAME, "r");
  if (fp == NULL)
    return EXIT_FAILURE;

  printf("1. é¦–æ¬¡æ‰“å¼€æ–‡ä»¶ï¼ŒæŒ‡é’ˆä½äºå¼€å¤´ã€‚\n");
  report_status(fp, "çŠ¶æ€A - è¯»å–å‰");

  // è¯»å–æ‰€æœ‰å­—ç¬¦ç›´åˆ°æ–‡ä»¶ç»“æŸ
  while ((c = fgetc(fp)) != EOF) {
    // ç¡®ä¿æ‰€æœ‰æ•°æ®éƒ½è¢«æ¶ˆè€—
  }

  printf("\n2. å·²è¯»å–æ–‡ä»¶æ‰€æœ‰å†…å®¹(fgetc è¿”å› EOF)ã€‚\n");

  // æ­¤æ—¶ï¼Œæ–‡ä»¶æŒ‡é’ˆè¶Šç•Œï¼ŒEOFæ ‡å¿—è¢«è®¾ç½®
  report_status(fp, "çŠ¶æ€B - è¯»å–åˆ° EOF ä¹‹å");

  // ===================================================================
  // æ­¥éª¤ B: åˆ¶é€ é”™è¯¯å¹¶æ¸…é™¤ (ferror å’Œ clearerr ç¤ºä¾‹)
  // ===================================================================

  // ä½¿ç”¨ fseek å¼ºåˆ¶å°†æŒ‡é’ˆç§»åŠ¨åˆ°æ–‡ä»¶æœ«å°¾ï¼ˆä½†æ–‡ä»¶ä»ç„¶æ˜¯åªè¯»æ¨¡å¼ï¼‰
  // å°è¯•åœ¨åªè¯»æ–‡ä»¶ä¸Šå†™å…¥æ•°æ®ï¼Œåœ¨æŸäº›ç³»ç»Ÿä¸Šä¼šè®¾ç½®é”™è¯¯æ ‡å¿—ã€‚
  fseek(fp, 0, SEEK_END);

  // å°è¯•å†™å…¥æ•°æ®ï¼Œç”±äºæ–‡ä»¶ä»¥ "r" æ¨¡å¼æ‰“å¼€ï¼ˆåªè¯»ï¼‰ï¼Œè¿™å°†å¤±è´¥ï¼Œå¹¶è®¾ç½®é”™è¯¯æ ‡å¿—
  // æ³¨æ„ï¼šè™½ç„¶ä¸èƒ½å†™å…¥ï¼Œä½† ferror é€šå¸¸åœ¨å°è¯•ä¸€ä¸ªéæ³•æ“ä½œåè¢«è®¾ç½®ã€‚
  // åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å°è¯•åœ¨åªè¯»æ–‡ä»¶ä¸Šä½¿ç”¨ fputcï¼Œå®ƒä¼šå¤±è´¥å¹¶è®¾ç½® ferror æ ‡å¿—ã€‚
  c = fputc('X', fp);

  // æ£€æŸ¥ fputc æ˜¯å¦å¤±è´¥(é€šå¸¸è¿”å› EOF)
  if (c == EOF) {
    printf("\n3. å°è¯•åœ¨åªè¯»æµä¸Šå†™å…¥æ•°æ®(fputc)å¤±è´¥ã€‚\n");
  }

  // æ­¤æ—¶ï¼Œé”™è¯¯æ ‡å¿— ferror è¢«è®¾ç½®
  report_status(fp, "çŠ¶æ€C - å°è¯•éæ³•å†™å…¥å");

  // clearerr ç¤ºä¾‹
  clearerr(fp);
  printf("4. ä½¿ç”¨ clearerr() æ¸…é™¤äº† EOF å’Œé”™è¯¯æ ‡å¿—ã€‚\n");

  report_status(fp, "çŠ¶æ€D - clearerr() ä¹‹å");

  fclose(fp);
  remove(FILENAME); // æ¸…ç†æ–‡ä»¶

  return EXIT_FAILURE;
}

void report_status(FILE *fp, const char *message) {
  printf("\n--- %s ---\n", message);

  // feof(fp): æ£€æµ‹æ˜¯å¦åˆ°è¾¾æ–‡ä»¶æœ«å°¾
  if (feof(fp)) {
    printf("FE_EOF: æ–‡ä»¶æµå·²åˆ°è¾¾æ–‡ä»¶æœ«å°¾ (EOF)ã€‚\n");
  } else {
    printf("FE_EOF: æ–‡ä»¶æµæœªåˆ°è¾¾æ–‡ä»¶æœ«å°¾ã€‚\n");
  }

  // ferror(fp)ï¼šæ£€æµ‹æ˜¯å¦å‘ç”Ÿäº† I/O é”™è¯¯
  if (ferror(fp)) {
    printf("F_ERROR: æ–‡ä»¶æµå‘ç”Ÿ I/O é”™è¯¯ã€‚\n");
  } else {
    printf("F_ERROR: æ–‡ä»¶æµçŠ¶æ€æ­£å¸¸ã€‚\n");
  }
}
~~~

## 15.15 ä¸´æ—¶æ–‡ä»¶

ä½¿ç”¨`tempfile()`å‡½æ•°åˆ›å»ºä¸€ä¸ªä»¥`wb+`æ¨¡å¼æ‰“å¼€çš„æ–‡æœ¬æ–‡ä»¶ç”¨æ¥ä¸´æ—¶ä¿å­˜æ•°æ®ã€‚å½“ç¨‹åºç»“æŸæ—¶è¿™ä¸ªæ–‡ä»¶ä¾¿è¢«åˆ é™¤`è‡ªåŠ¨è¢«æ‰§è¡Œremove()`å‡½æ•°ã€‚

~~~C
FILE *tmpfile(void);
~~~

> å¦‚æœæƒ³è¦æ–‡ä»¶ä»¥åªè¯»æ¨¡å¼æ‰“å¼€æˆ–ä¸ä»¥`wb+`æ¨¡å¼æ‰“å¼€å¿…é¡»ä½¿ç”¨`fopen()`å‡½æ•°æ“ä½œ

å¯ä»¥ä½¿ç”¨`tmpnam()`å‡½æ•°ä¸ºä¸´æ—¶æ–‡ä»¶åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å
> tmpnam() ä»…ä»…æ˜¯ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„æ–‡ä»¶åå­—ç¬¦ä¸²ï¼Œä½†ä¸åˆ›å»ºæ–‡ä»¶ã€‚ä½ éœ€è¦æ‰‹åŠ¨ä½¿ç”¨ fopen() æ¥åˆ›å»ºå’Œæ‰“å¼€æ–‡ä»¶ï¼Œå¹¶è´Ÿè´£åœ¨ç¨‹åºç»“æŸæ—¶æ‰‹åŠ¨åˆ é™¤å®ƒã€‚ä¸”**tmpnam**ä¸å®‰å…¨ï¼

~~~C
char *tmpnam(char *name);
~~~

ä¸¤ä¸ªä¾‹å­

~~~C
# include <stdio.h>
# include <stdlib.h>
# include <string.h>
int main(void) {
  FILE *tmp_fp;
  char write_data[] = "Temporary data buffer";
  char read_buffer[100];

  // 1. åˆ›å»ºä¸´æ—¶æ–‡ä»¶æµ
  // FILE* tmpfile(void);
  tmp_fp = tmpfile();

  if (tmp_fp == NULL) {
    perror("Failed to open tmpfile.\n");
    return EXIT_FAILURE;
  }

  printf("æˆåŠŸåˆ›å»ºä¸´æ—¶æ–‡ä»¶æµã€‚è¯¥æ–‡ä»¶å°†åœ¨ç¨‹åºé€€å‡ºæ—¶è‡ªåŠ¨åˆ é™¤ã€‚\n");

  // 2. å†™å…¥æ•°æ®åˆ°ä¸´æ—¶æ–‡ä»¶
  if (fputs(write_data, tmp_fp) != EOF) {
    printf("å†™å…¥æ•°æ®æˆåŠŸï¼š\"%s\"\n", write_data);
  } else {
    perror("Error writing to temporary file");
  }

  // 3. å°†æ–‡ä»¶æŒ‡é’ˆé‡ç½®åˆ°å¼€å¤´
  rewind(tmp_fp);

  // 4. ä»ä¸´æ—¶æ–‡ä»¶è¯»å–æ•°æ®
  if (fgets(read_buffer, sizeof(read_buffer), tmp_fp) != NULL) {
    printf("ä»ä¸´æ—¶æ–‡ä»¶è¯»å–æ•°æ®ï¼š\"%s\"\n", read_buffer);
  } else {
    perror("Error reading from temporary file");
  }

  // 5. å…³é—­æ–‡ä»¶æµ
  // å½“æ–‡ä»¶æµå…³é—­æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ é™¤è¿™ä¸ªä¸´æ—¶æ–‡ä»¶

  if (fclose(tmp_fp) == 0) {
    printf("\nä¸´æ—¶æ–‡ä»¶æµå…³é—­æˆåŠŸï¼Œä¸´æ—¶æ–‡ä»¶å·²è¢«åˆ é™¤ã€‚\n");
  } else {
    perror("Error closing temporary file");
  }

  return EXIT_SUCCESS;
}
~~~

~~~C
# include <stdio.h>
# include <stdlib.h>
# include <string.h>
# include <time.h>

int main(void) {
  char
      temp_filename[L_tmpnam]; // L_tmpnam æ˜¯ <stdio.h> ä¸­çš„å®ï¼Œä¿è¯ç¼“å†²åŒºè¶³å¤Ÿå¤§
  FILE *fp;

  // 1. ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„æ–‡ä»¶å
  // å¦‚æœä¼ å…¥NULLï¼Œ tmpnam ä¼šä½¿ç”¨ å†…éƒ¨é™æ€ç¼“å†²åŒºï¼Œä½†æˆ‘ä»¬ä½¿ç”¨å±€éƒ¨æ•°ç»„æ›´å®‰å…¨
  if (tmpnam(temp_filename) != NULL) {
    printf("ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶åæ˜¯ï¼š%s\n", temp_filename);
  } else {
    fprintf(stderr, "tmpnam failed to generate temporary file.");
    return EXIT_FAILURE;
  }

  // 2. æ‰‹åŠ¨åˆ›å»ºå’Œæ‰“å¼€æ–‡ä»¶
  fp = fopen(temp_filename, "w");
  if (fp == NULL) {
    perror("Error opening the generated temporary file");
    return EXIT_FAILURE;
  }

  printf("æ‰‹åŠ¨åˆ›å»ºå¹¶æ‰“å¼€äº†æ–‡ä»¶ã€‚\n");

  // 3. å†™å…¥å’Œå…³é—­æ–‡ä»¶...
  fprintf(fp, "This is manually managed temporary data.\n");
  fclose(fp);

  // 4. ã€é‡è¦ã€‘æ‰‹åŠ¨åˆ é™¤æ–‡ä»¶
  if (remove(temp_filename) == 0) {
    printf("æ‰‹åŠ¨åˆ é™¤äº†ä¸´æ—¶æ–‡ä»¶ï¼š%s\n", temp_filename);
  } else {
    perror("Error deleting temporary file");
  }
  return EXIT_SUCCESS;
}
~~~

## 15.16 æ–‡ä»¶æ“çºµå‡½æ•°

æœ‰ä¸¤ä¸ªå‡½æ•°ç”¨äºæ“çºµæ–‡ä»¶ä½†ä¸æ‰§è¡Œä»»ä½•è¾“å…¥/è¾“å‡ºæ“ä½œã€‚

~~~C
int remove(char const *filename);
int rename(char const *oldname, char const *newname);
~~~

`remove`å‡½æ•°åˆ é™¤ä¸€ä¸ªæŒ‡å®šçš„æ–‡ä»¶ã€‚å¦‚æœå½“removeè¢«è°ƒç”¨æ—¶æ–‡ä»¶å¤„äºæ‰“å¼€çŠ¶æ€ï¼Œå…¶ç»“æœå–å†³äºç¼–è¯‘å™¨ã€‚

`rename`å‡½æ•°ç”¨äºæ”¹å˜ä¸€ä¸ªæ–‡ä»¶çš„åå­—ï¼Œä»**oldname**æ”¹ä¸º**newname**ã€‚å¦‚æœå·²ç»æœ‰ä¸€ä¸ª**newname**çš„æ–‡ä»¶å­˜åœ¨ï¼Œå…¶ç»“æœå–å†³äºç¼–è¯‘å™¨ã€‚
